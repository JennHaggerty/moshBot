var request 		= require('request');
var base64 			= require('base-64');
var nodemailer  = require('nodemailer');

var config 			= require('./config');

var tourBoards 	= config.tourBoards;
var whiteList 	= config.whiteList;
var password 		= config.password;

password = base64.decode(password);

var transporter = nodemailer.createTransport({
	service: 'Gmail',
	auth: {
		user: config.gmail,
		pass: password
	}
});

// if PASSWORD env.var is missing, exit the program
if(!config) {
  console.log("You need a config/ file!");
  process.exit(1);
}
// 1. Get events from TM
// 2. Check events against whiteList
// 3. Email concert details
getEvents();
function getEvents() {
	// iterate through tourBoards
	for (i = 0; i < tourBoards.length; i++) {
		// requesting remote concert board from url (tourBoards[i])
		request(tourBoards[i], function (error, response, body) {
			//if error occurs, spits out error to log
			if(error) { console.log(error); }
			//get all events from tourBoards
			if (!error && response.statusCode == 200) {
				var json = JSON.parse(body);
				concerts = json._embedded.events;
				//loop through all events
				for (j = 0; j < concerts.length; j++) {
					var name = concerts[j].name;
					var date = concerts[j].dates.start.localDate;
					var time = concerts[j].dates.start.localTime;
var time = time.substring(0, 5);
					var state = concerts[j].dates.timezone;
					var link = concerts[j].url;
					//check bandName against whiteList
					for (k = 0; k < whiteList.length; k++) {
						var whiteListItem = whiteList[k];
						//log event if bandName has whiteListItem
						if(name.indexOf(whiteListItem) > -1) {
							//console.log(name);
							//console.log(date);
							//console.log(state);
var email = name+" in "+state+" on "+date+" @ "+time+" hours. "+link;
console.log(email);
							//transporter.sendMail({
							//	from: config.gmail,
							//	to: config.gmail,
							//	subject: 'Moshbot detects a pit!',
							//	text: email
							//});
						}
					}
				}
			}
		});
	}
}